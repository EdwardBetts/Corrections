<html>
<head>
<title>Corrections</title>
</head>
<body>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js"></script>
<script>
$(function () {
    $("span.word").click(function () {
        var input = $("<input />");
        input.width(Math.max(14, $(this).parent().width()));
        input.val($(this).text());
        input.keydown(function() { $('#saveButton').removeAttr('disabled') });
        input.attr('id', $(this).attr('id'));
        $(this).replaceWith(input);
    })
})

function saveEdits () {
    edits = new Object();
 
    $('input').each(function () {
        var edit_id = $(this).attr('id');
        var word = $(this).val();
        edits[edit_id] = word
        console.log(edit_id + ' ' + word);
    });
    $.ajax({
        url: '{{ url_for('save', identifier=item.identifier, page=leaf) }}',
        data: edits,
        type: 'POST',
        complete: function() {
            $('#msg').show();
            $('#saveButton').attr('disabled', 'disabled')
        },
    });
}
</script>

<div style="position:absolute;top:0px;">
<a href="{{url_for('leaf', identifier=item.identifier, leaf=leaf-1)}}">&lt;- Prev</a>
<a href="{{url_for('item', identifier=item.identifier)}}">Index</a>
<a href="{{url_for('leaf', identifier=item.identifier, leaf=leaf+1)}}">Next -&gt;</a>
<a href="http://www.archive.org/stream/{{item.identifier}}#page/n{{leaf}}/mode/1up">View in book reader</a>
<button type="button" id="saveButton" onclick="saveEdits()" disabled="disabled">Save</button>
<span id="msg" style="display:none">saved</span>
</div>

{% set out_y = 40 %}
{% set scale = 2 %}
{% if not item.leaf0_missing %}
{% set leaf = leaf - 1 %}
{% endif %}
{% for t, b, line in lines %}
    {% set line_offset = loop.index0 %}
    {% set y = t - 20 %}
    {% set h = (b - t) + 40 %}
    <img src="http://www.archive.org/download/{{item.identifier}}/page/n{{leaf}}_x{{text_x}}_y{{y}}_h{{h}}_w{{text_w}}_s{{scale}}.jpg" height="{{h/scale}}" width="{{text_w/scale}}" style="position:absolute;top:{{out_y}}px;">
    <div style="position:absolute;top:{{ out_y + 10 + h/scale}}px;height:{{h/scale}}px;">
    {% for fmt in line %}
        {% set fs = max([9, (Decimal('3.5') * Decimal(fmt.get('fs'))) /scale]) %}
        <span style="font-size:{{ fs }}pt;{% if fmt.get('italic') == 'true' %}font-style:italic{% endif %}">
        {%- for word in group_words(fmt) -%}
            {%- if word[0].text != ' ' -%}
                {%- set w = (int(word[-1].get('r')) - int(word[0].get('l'))) / scale -%}
                {%- set word_x = int(word[0].get('l')) - text_x -%}
                <span style="position:absolute;left:{{word_x / scale}}px;height:{{(b - t) / 2 }}px;width:{{w}}px;border:red 1px solid;">
                <span class="word" id="word_{{ line_offset }}_{{ word[0].get('char_offset') }}">
                {%- for c in word -%}
                    {%- set char_w = (int(c.get('r')) - int(c.get('l'))) / scale -%}
                    <span style="position:absolute;left:{{((int(c.get('l')) - text_x) - word_x) / scale}}px;width:{{char_w}}px">{{c.text}}</span>
                {%- endfor -%}
                </span>
                </span>
            {%- endif -%}
        {%- endfor -%}
        </span>
    {% endfor %}
    </div>
    {% set out_y = out_y + h %}

{% endfor %}

</body>
</html>
